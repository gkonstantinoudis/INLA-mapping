---
title: "Shefield"
author: "GK"
date: "17 September 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(maptools)
library(spdep)
library(INLA)

```

## Stroke mortality in Sheffield

In this practical you will work with the Sheffield dataset (also included in the "Spatial and Spatio-Temporal Bayesian Models with R-INLA book used in Chapter 5"). The dataset included information about stroke mortality in Sheffield (counts of deaths), population at risk and relevant covariates (NOx concentration, and Townsend index, which is a deprivation index). In the folder provided there is also a shapefile with the enumeration districts for the city of Sheffield. 


## Importing/cleaning data

```{r}
setwd("G:/Back up 03.04.2018/PhD/lectures/181030_INLA_ZH/Cardio Sheffield/")
stroke <- read.csv("Stroke.csv")

head(stroke)
plot(stroke$stroke_exp)
table(stroke$Townsend.class)
table(stroke$NOx.class)

```

The dataset has 9 columns. The SP_ID gives us information about the ID of the enumeration districts, the columns stroke_exo and pop give infomation about the expected number of deaths and the population at risk at the ith spatial unit. Information on counts of stroke are given by the variable y. Covariate information (in quintiles) is given in the columns Townsend.class (deprivation) and NOx.class (air pollutant used to capture mainly traffic related air pollution). Townsend and NOx give the categories of the class of this covariates and the offset is defined as $\text{offset}_i = \text{logit}_i(E_i/\text{Pop}_i)$.

Now lets have a look at the enumeration districts of Sheffield. Please notice that the number of rows in the shapefile is the same as the number of rows in our dataset.

```{r}

library(maptools)
sheffield.gen <- readShapePoly("Sheffield.shp")
plot(sheffield.gen)
nrow(stroke)

```

The research question of this particular problem is to examine the spatial distribution of deaths by stroke in Sheffield and examine to which extent this distribution can be explained by variables as traffic-related air pollution and deprivation. We are also interested in examining the ecological association between these covariates and stroke mortality. To answer these questions we will perform disease mapping and ecological regression with INLA. We will use the binomial distribution rather the Poisson one for this example, since stroke is not a rare outcome:

$$y_i \sim \text{Binomial}(p_i, n_i)\\
\text{logit}(p_i) = \beta_0 +  u_i + v_i\\
u_{i}|\mathbf{u}_{-i} \sim \mathcal{N}\Big(\frac{\sum_{j=1}^Nw_{ij}u_j}{\sum_{j = 1}^{N}w_{ij}}, \frac{1}{\tau_1\sum_{j=1}^{N}w_{ij}}\Big) \\[5pt]
				v_i \sim \mathcal{N}(0, \tau_2^{-1}) \\$$

as before we considered the reparametrization of Simpson, however by typing model = "bym" you fit exactly the above model.
```{r}
# define the neighbour structure
W.nb <- poly2nb(sheffield.gen)
nb2INLA("W.adj", W.nb)

# match
stroke<- stroke[match(sheffield.gen$SP_ID,stroke$SP_ID),]
#Check for the first 10 areas
stroke$SP_ID[1:10]
sheffield.gen$SP_ID[1:10]

# create an ID per spatial unit
stroke$ID<- seq(1,1030)

```
## Disease mapping stroke mortality

Here we will fit a BYM model without covariates

```{r message=FALSE, warning=FALSE}

formula <- y ~ 1 + f(ID, model="bym2", graph="W.adj", scale.model = TRUE, constr = TRUE, 
               # priors
               hyper = list(theta1 = list("PCprior", c(1, 0.01)),  
                            # Pr(sd<1) = 0.01, unlikely to have rr>3just based on the spatial confounding
                            theta2 = list("PCprior", c(0.5, 0.5))) 
                            # Pr(phi<0.5)=0.5, we state that we believe that the unmeasured spatial confounding
                            # is driven 50% from the strucutred and 50% from the unstructured random effect
               )

strokes_DM <- inla(formula, data = stroke, family="binomial",  offset=Offset, Ntrials=pop,
                   control.compute = list(dic = TRUE, waic = TRUE), verbose = F)

strokes_DM$summary.hyperpar
# tranform to get the standard deviation

sd <- inla.tmarginal(function(x) exp(-1/2*x), strokes_DM$internal.marginals.hyperpar$`Log precision for ID`)

plot(sd, type = "l", xlim = c(0, 1))
plot(strokes_DM$marginals.hyperpar$`Phi for ID`, type = "l")

```

How would you interpret these plots?

```{r message=FALSE, warning=FALSE}
sheffield.gen$sp <- strokes_DM$summary.random$ID$`0.5quant`[1:1030]
spplot(sheffield.gen, "sp", col = "transparent")

# calculate also exceedance probability
threshold <- log(1)
exceed.prob <- lapply(X= strokes_DM$marginals.random$ID[1:1030], FUN = function(x) inla.pmarginal(marginal = x, threshold))
exceed.prob <- 1 - unlist(exceed.prob)
boxplot(exceed.prob)
abline(h = 0.95, col = "red")

sheffield.gen$ex <- exceed.prob
temp.ex <-  sheffield.gen[sheffield.gen$ex >=0.95,]

library(latticeExtra)
# http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf
spplot(sheffield.gen, "ex", col = "transparent", col.regions = colorRampPalette(c('white', "seagreen"))(16)) + layer(sp.polygons(temp.ex, col="red", lwd = 2)) 

```

At this point and based on Occam's razor  grounds it would make sense to fit a model with just an ustructured random effect and compare the models. 

```{r}
formula_2 <- y ~ 1 +  f(ID, model="iid", constr = TRUE, hyper = list(theta = list("PCprior", c(1, 0.01))))
                        
strokes_DM_unstr <- inla(formula_2, data = stroke, family="binomial",  offset=Offset, Ntrials=pop,
                   control.compute = list(dic = TRUE, waic = TRUE), verbose = F)

strokes_DM$dic$dic; strokes_DM_unstr$dic$dic

# it seems that the models without a spatial component performs better.
```

## Ecological regression stroke mortality

Now we will add the covariates of interest:

$$y_i \sim \text{Binomial}(p_i, n_i)\\
\text{logit}(p_i) = \beta_0 + \beta_1\text{Townsend} + \beta_2\text{NOx} + u_i + v_i\\
u_{i}|\mathbf{u}_{-i} \sim \mathcal{N}\Big(\frac{\sum_{j=1}^Nw_{ij}u_j}{\sum_{j = 1}^{N}w_{ij}}, \frac{1}{\tau_1\sum_{j=1}^{N}w_{ij}}\Big) \\[5pt]
				v_i \sim \mathcal{N}(0, \tau_2^{-1}) \\
				\beta_1, \beta_2 \sim \mathcal{N}(0, 0.5)$$
				
Lets first plot them

```{r}
sheffield.gen$NOx <- stroke$NOx.class
spplot(sheffield.gen, "NOx", col = "transparent", main = "NOx Class")

sheffield.gen$depr <- stroke$Townsend.class
spplot(sheffield.gen, "depr", main = "Townsend Class")

```

What do you observe?

Now we will perform ecological regression.

```{r message=FALSE, warning=FALSE}
formula_eco <- y ~  1 + Townsend + NOx + 
               f(ID, model="bym2", graph="W.adj", scale.model = TRUE, constr = TRUE, 
               # hyper priors
               hyper = list(theta1 = list("PCprior", c(1, 0.01)),  
                            theta2 = list("PCprior", c(0.5, 0.5))) 
               )

model_eco <- inla(formula_eco, family="binomial", data=stroke, offset=Offset, Ntrials=pop, control.compute = list(dic = TRUE, waic = TRUE), control.fixed=list(prec=list(mean=0, prec=0.5)))

# odds ratio
exp(model_eco$summary.fixed[c("Townsend", "NOx"),c("0.025quant", "0.5quant", "0.975quant")])

```

Now lets check the residual spatial variation

```{r}
plot(model_eco$marginals.hyperpar$`Phi for ID`, type = "l", main = "mixing parameter")
```

almost the entire amount of variation is due to the ustructured random effect. 

```{r}
sheffield.gen$sp_eco <- model_eco$summary.random$ID$`0.5quant`[1:1030]
spplot(sheffield.gen, "sp_eco", col = "transparent")
```

not much of variation was explained by the covariates. 

